---
title: "Анализ lifetime клиента (дожития)"
output:
  pdf_document: default
  html_notebook: default
---

## Что такое анализ дожития?
Название взято из медицины, т.к. суть анализа заключается в изучении продолжительности жизни пациента после приема препарата или других факторов влияния на здоровье. Поэтому и называется он - анализ дожития (survival analysis).

В нашем случае анализ может быть применем для оценки lifetime пользователей в продукте. Метод часто применяется для расчета LTV на конкретный день использования сервиса. Также широкую практику анализ приобрел в HR-практике в средних-крупных компаниях, чтобы предсказывать время пребывания в компании еще на этапе отсмотра CV кандидата. 

*Анализ помогает ответить на вопрос: Как долго пользователь "живет" в сервисе/продукте?*

## Загрузка данных и их описание
Взглянем на данные
```{r data 1}
df_surv <- read.table("https://raw.githubusercontent.com/aboutisya/r_surv/master/df_surv.csv",
                       row.names = 1, 
                       sep= ";",
                       header=T)

head(df_surv)
```
Представим, что мы анализируем отток пользователей:

* uid - уникальный id пользователя
* group - группа, к которой относится пользователь
* time - время дожития от начала регистрации в сервисе в днях
* churned - факт оттока. Обратите внимание, что 0 говорит о наличии активности на time-день, а 1 об уходе из сервиса (допустим, не было следующей оплаты)

Некоторое описание данных:
```{r data 2}
str(df_surv)

# доли ушедших и оставшихся по группам
table(df_surv$churned,df_surv$group)

```

## Анализ дожития
#### Анализ без факторов
Для анализа дожития используется регрессия с двумя зависимыми переменными: время и событие. Для своего анализа мы будем использовать процедуру Каплана-Мейера (Kaplan-Meier estimator). В R это делается достаточно просто:
```{r km 1}
# Загрузим необходимые библиотеки. Если их нет, то install.packages()
library(survival)
library(survminer)

fit_km <- survfit(Surv(time, churned) ~ 1, data = df_surv)
fit_km
```

~1 в формуле означает, что мы считаем модель без факторов. Такая модель позволит посмотреть на общую картину оттока. В результате мы видим медианный день пребывания на сервисе и 95%ДИ для нее. Но медиана здесь рассчитывалась иначе, чем если бы мы просто применили `median()`. В данном случае, 318 -- день для 0.5 вероятности дожития.

Чтобы проще было понимать, о чем речь, давайте взглянем на график:
```{r km 2}
ggsurvplot(fit_km ,main = "Вероятность дожития", 
           xlab = "Время (дни)", 
           ylab = "Дожитие (вероятность)", 
           palette = "npg",
           censor = T,
           conf.int = T,
           risk.table = T,
           ggtheme = theme_minimal())$plot
```
График хорошо показывает, как с течение времени падает вероятность дожить на до конкретного дня. 

```{r km 3}
#Если угодно, то можно забрать данные из модели в табличный вид
dat_km <- fortify(fit_km)
head(dat_km)
```

Чтобы было нагляднее основные точки отсечения модели, выделим пунктирными линиями 25, 50 и 75 квантили
```{r km 4}
mc <- data.frame(q = c(.25, .5, .75),
                  km = quantile(fit_km))

ggsurvplot(fit_km ,main = "Вероятность дожития", 
           xlab = "Время (дни)", 
           ylab = "Дожитие (вероятность)", 
           palette = "npg",
           censor = T,
           conf.int = T,
           risk.table = T,
           ggtheme = theme_minimal())$plot +
  geom_segment(data = mc, aes(x = km.quantile, y = 1-q, xend = km.quantile, yend = 0), lty = 3) +
  geom_segment(data = mc, aes(x = 0, y = 1-q, xend = km.quantile, yend = 1-q), lty = 3)
```

Выведем результат
```{r km 5}
mc
```
25% ушедших в пределах 132 дней. Можно обратить внимание на отрезок между 50 и 75 квантилей, он достаточно затяжной -- 533 дня против 132. 

#### Анализ факторов
Мы можем объяснять зависимость дожития с помощью вспомогательных переменных. Для этого вместо единички в формуле подставим необходимый фактор:
```{r km group 1}
fit_km_w_fct <- survfit(Surv(time, churned) ~ group, data = df_surv)
fit_km_w_fct
```

Группа В кажется живет дольше, но по ДИ95 уже видно, что значимой разницы между ними нет. Построим график:

```{r km group 2}
ggsurvplot(fit_km_w_fct, 
           risk.table = T,
           palette = "aaas", 
           xlab = "Время (дни)", 
           ylab = "Дожитие (вероятность)", 
           censor = T,
           conf.int = T,
           ggtheme = theme_minimal())$plot
```

## Выводы
Анализ выживаемости или анализ дожития (survival analysis) является полезным инструментом в задачах прогноза пребывания пользователя в сервисе. Также стоит отметить, что существует возможность объяснять этот прогноз с помощью дополнительных переменных, как мы увидели это в разбивке по группам А и В. 


